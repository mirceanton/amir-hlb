---
- name: Configure Automaton
  hosts: automaton
  become: true

  pre_tasks:
    - name: Update and Upgrade System
      ansible.builtin.apt:
        upgrade: dist
        update_cache: true
        cache_valid_time: 3600

    - name: Install Utility Packages
      ansible.builtin.apt:
        name: "{{ item }}"
        state: "{{ apt_utility_state }}"
      loop: "{{ apt_utility_packages }}"

    - name: Create required directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "u=rwx,g=rx,o="
        owner: mike
        group: mike
      loop:
        - "{{ docker_data_dir }}"
        - "{{ backup_dir_path }}"
        - /opt/scripts/
        - /opt/credentials/traefik
        - /opt/credentials/vault
        - /opt/credentials/portainer
        - /opt/credentials/minio
        - /opt/credentials/jenkins
        - /opt/credentials/gitlab

  roles:
    # Installed required packages for local development
    - role: mirceanton.terraform
    - role: mirceanton.packer
    - role: mirceanton.ansible

    # Install docker to host services
    - role: mirceanton.docker

    - role: mirceanton.anacron

  tasks:
    - name: Copy backup script to location
      ansible.builtin.copy:
        src: files/automaton-backup.sh
        dest: "{{ backup_script_path }}"
        owner: root
        group: root
        mode: "u=rwx,g=rw,o="