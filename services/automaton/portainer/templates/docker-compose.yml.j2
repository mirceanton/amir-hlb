{% import "macros.j2" as templates with context %}
---
version: '{{ docker_compose_version }}'

services:
  app:
    image: {{ portainer_stack_image_name }}:{{ portainer_stack_image_tag }}
    command: -H tcp://tasks.agent:9001 --tlsskipverify --admin-password "{{ portainer_admin_password | password_hash('bcrypt') | replace('$','$$') }}"
    environment:
      VIRTUAL_HOST: 'portainer.{{ fqdn }}'
      VIRTUAL_PORT: '9000'

    volumes:
      - {{ portainer_stack_data_dir_path }}/data:/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

    networks:
      - {{ docker_proxy_network }}
      - internal

    healthcheck:
      test: "wget --no-verbose --tries=1 --spider --no-check-certificate https://localhost:9443 || exit 1"
      interval: {{ docker_healthcheck_interval }}
      timeout: {{ docker_healtcheck_timeout }}
      retries: {{ docker_healthcheck_retries }}

    deploy:
      mode: replicated
      replicas: 1

      placement:
        constraints:
          - node.role == manager

      {{ templates.restart_policy() | indent(6) }}

      labels:
        # Enable traefik to proxy this service
        - 'traefik.enable=true'
        {{ templates.traefik_labels('portainer', '9000') | indent(8) }}

  agent:
    image: {{ portainer_stack_agent_image_name }}:{{ portainer_stack_agent_image_tag }}

    environment:
      AGENT_CLUSTER_ADDR: tasks.agent
      LOG_LEVEL: DEBUG
      AGENT_PORT: 9001

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes

    networks:
      - internal

    deploy:
      mode: global
      {{ templates.restart_policy() | indent(6) }}

networks:
  {{ docker_proxy_network }}:
    external: true
  internal:
    driver: overlay
    ipam:
      config:
        - subnet: 172.16.1.0/24
